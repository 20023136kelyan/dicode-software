rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to check if user created the resource
    function isCreator() {
      return isAuthenticated()
        && resource.data.metadata.createdBy == request.auth.uid;
    }

    // Helper function to check if user will be the creator (for writes)
    function willBeCreator() {
      return isAuthenticated()
        && request.resource.data.metadata.createdBy == request.auth.uid;
    }

    // Helper function to check if user is an admin of an organization
    function isOrgAdmin(organizationId) {
      return isAuthenticated()
        && exists(/databases/$(database)/documents/organizations/$(organizationId))
        && request.auth.uid in get(/databases/$(database)/documents/organizations/$(organizationId)).data.adminIds;
    }

    // Helper function to get user's organization from document (for single doc reads)
    function getUserOrganization() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.organization;
    }

    // Helper function to get user's organization from token (for list queries - faster, no doc read)
    // Custom claims are set by Cloud Functions when user's organization changes
    function getTokenOrganization() {
      return request.auth.token.organizationId;
    }

    // Helper function to check if user is DiCode Staff (Super Admin)
    function isDiCodeStaff() {
      return request.auth.token.email.split('@')[1] == 'di-code.de';
    }

    // Organizations Collection
    match /organizations/{organizationId} {
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        isOrgAdmin(organizationId) ||
        // Allow members of the organization to read their org doc (fallback when adminIds missing)
        organizationId == getUserOrganization()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (isDiCodeStaff() || isOrgAdmin(organizationId));
      allow delete: if isAuthenticated() && (isDiCodeStaff() || isOrgAdmin(organizationId));
    }

    // Users Collection
    match /users/{userId} {
      allow read: if isOwner(userId) ||
        (isAuthenticated() && (
          isDiCodeStaff() ||
          isOrgAdmin(resource.data.organization) ||
          resource.data.organization == getUserOrganization() ||
          // Fallback: user doc missing org but caller is admin of their own org
          (resource.data.organization == null && isOrgAdmin(getUserOrganization()))
        ));
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) ||
        (isAuthenticated() && (isDiCodeStaff() || isOrgAdmin(resource.data.organization)));
      allow delete: if isOwner(userId) ||
        (isAuthenticated() && (isDiCodeStaff() || isOrgAdmin(resource.data.organization)));
    }

    // Cohorts Collection
    match /cohorts/{cohortId} {
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        isOrgAdmin(resource.data.organization) ||
        // Allow org members to read cohorts when org matches or org is missing
        (resource.data.organization == getUserOrganization()) ||
        (resource.data.organization == null && getUserOrganization() == null) ||
        // Allow access when the user is explicitly a member of the cohort
        (resource.data.employeeIds != null && request.auth.uid in resource.data.employeeIds)
      );
      allow create: if isAuthenticated() && (
        isDiCodeStaff() || isOrgAdmin(request.resource.data.organization)
      );
      allow update: if isAuthenticated() && (
        isDiCodeStaff() || isOrgAdmin(resource.data.organization)
      );
      allow delete: if isAuthenticated() && (
        isDiCodeStaff() || isOrgAdmin(resource.data.organization)
      );
    }

    // Campaigns Collection
    match /campaigns/{campaignId} {
      // DiCode Staff can read ALL campaigns
      allow read: if isAuthenticated() && isDiCodeStaff();

      // Other users: Creator OR org is in allowedOrganizations (or list is empty/public)
      allow read: if isAuthenticated() && (
        // Creator (Client Admin)
        isCreator() ||
        // User's org is in the allowed list
        getUserOrganization() in resource.data.allowedOrganizations ||
        // Public campaigns (empty or null allowedOrganizations)
        resource.data.allowedOrganizations == null ||
        resource.data.allowedOrganizations.size() == 0
      );
      
      // Write: DiCode Staff OR Org Admin/Creator for their own campaigns
      allow create: if isAuthenticated() && (
        isDiCodeStaff() ||
        (request.resource.data.source == 'dicode' && isDiCodeStaff()) ||
        (request.resource.data.source == 'organization' && willBeCreator())
      );
      allow update: if isAuthenticated() && (
        isDiCodeStaff() ||
        (resource.data.source == 'dicode' && isDiCodeStaff()) ||
        (resource.data.source == 'organization' && isCreator())
      );
      // DiCode Staff can delete any campaign
      allow delete: if isAuthenticated() && (
        isDiCodeStaff() ||
        (resource.data.source == 'dicode' && isDiCodeStaff()) ||
        (resource.data.source == 'organization' && isCreator())
      );
    }

    // Campaign Items Collection
    match /campaignItems/{itemId} {
      // Allow DiCode Staff to read ALL campaign items (needed for deleteVideo integrity check)
      // Other users can read if the parent campaign exists
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        exists(/databases/$(database)/documents/campaigns/$(resource.data.campaignId))
      );
      
      // DiCode staff can manage any campaign items, or campaign creator can manage their own
      // For create: use request.resource.data (incoming data)
      allow create: if isAuthenticated() && (
        isDiCodeStaff() ||
        (
          exists(/databases/$(database)/documents/campaigns/$(request.resource.data.campaignId)) &&
          get(/databases/$(database)/documents/campaigns/$(request.resource.data.campaignId)).data.metadata.createdBy == request.auth.uid
        )
      );
      // For update/delete: use resource.data (existing data)
      allow update, delete: if isAuthenticated() && (
        isDiCodeStaff() ||
        (
          exists(/databases/$(database)/documents/campaigns/$(resource.data.campaignId)) &&
          get(/databases/$(database)/documents/campaigns/$(resource.data.campaignId)).data.metadata.createdBy == request.auth.uid
        )
      );
    }

    // Campaign Enrollments Collection
    match /campaignEnrollments/{enrollmentId} {
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        isOwner(resource.data.userId) ||
        // Org admins can read enrollments of users in their organization (via enrollment's orgId)
        (resource.data.organizationId != null && resource.data.organizationId != '' && isOrgAdmin(resource.data.organizationId)) ||
        // Token-based org check for list queries (uses custom claims, no doc read required)
        (resource.data.organizationId != null && resource.data.organizationId != '' && resource.data.organizationId == getTokenOrganization()) ||
        // Fallback document-based org check (for single doc reads or when token claims not yet set)
        (resource.data.organizationId != null && resource.data.organizationId != '' && resource.data.organizationId == getUserOrganization()) ||
        // Legacy fallback: Check if the enrollment's user belongs to caller's organization (for enrollments with empty/missing orgId)
        (exists(/databases/$(database)/documents/users/$(resource.data.userId)) &&
         get(/databases/$(database)/documents/users/$(resource.data.userId)).data.organization == getUserOrganization())
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        isDiCodeStaff() ||
        isOwner(resource.data.userId) ||
        // Org admins can update enrollments in their organization
        (resource.data.organizationId != null && resource.data.organizationId != '' && isOrgAdmin(resource.data.organizationId)) ||
        // Org admins can update legacy enrollments (empty orgId) if the enrolled user is in their org
        ((resource.data.organizationId == null || resource.data.organizationId == '') &&
         exists(/databases/$(database)/documents/users/$(resource.data.userId)) &&
         isOrgAdmin(get(/databases/$(database)/documents/users/$(resource.data.userId)).data.organization))
      );
      allow delete: if isAuthenticated() && (
        isDiCodeStaff() ||
        isOwner(resource.data.userId) ||
        // Org admins can delete enrollments in their organization
        (resource.data.organizationId != null && resource.data.organizationId != '' && isOrgAdmin(resource.data.organizationId))
      );
    }

    // Campaign Progress Collection
    match /campaignProgress/{progressId} {
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        isOwner(resource.data.userId)
      );
      allow create: if isAuthenticated() && (isDiCodeStaff() || isOwner(request.resource.data.userId));
      allow update: if isAuthenticated() && (isDiCodeStaff() || isOwner(resource.data.userId));
      allow delete: if isAuthenticated() && (isDiCodeStaff() || isOwner(resource.data.userId));
    }

    // Campaign Responses Collection
    match /campaignResponses/{responseId} {
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        // User can read their own responses
        isOwner(resource.data.userId) ||
        // Allow org-level reads for comparison/analytics
        (getUserOrganization() != null && resource.data.organizationId == getUserOrganization())
      );
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if false; // Immutable
      // DiCode staff can delete responses when deleting an organization
      allow delete: if isAuthenticated() && isDiCodeStaff();
    }

    // Campaign Notifications Collection
    match /campaignNotifications/{notificationId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if false; // Cloud Functions only
      allow update: if false; 
      allow delete: if false;
    }

    // Campaign Instances Collection
    match /campaignInstances/{instanceId} {
      allow read: if isAuthenticated();
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // Invitations Collection
    match /invitations/{invitationId} {
      allow read: if isAuthenticated() && (
        isOrgAdmin(resource.data.organizationId) ||
        resource.data.email == request.auth.token.email
      );
      allow create: if isAuthenticated() && isOrgAdmin(request.resource.data.organizationId);
      allow update: if isAuthenticated() && (
        isOrgAdmin(resource.data.organizationId) ||
        resource.data.email == request.auth.token.email
      );
      allow delete: if isAuthenticated() && isOrgAdmin(resource.data.organizationId);
    }

    // Videos Collection
    match /videos/{videoId} {
      // Publicly readable by authenticated users (General Assets)
      allow read: if isAuthenticated();
      // Only DiCode Staff can create/update/delete videos
      allow create, update, delete: if isAuthenticated() && isDiCodeStaff();
    }

    // Assets Collection
    match /assets/{assetId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && isDiCodeStaff();
    }

    // Activities Collection (Activity Tracking)
    match /activities/{activityId} {
      // All authenticated users can read activities
      allow read: if isAuthenticated();
      // All authenticated users can create activities (logging their own actions)
      allow create: if isAuthenticated();
      // No updates or deletes - activities are immutable audit logs
      allow update, delete: if false;
    }

    // Notifications Collection (Cross-User Notification Center)
    match /notifications/{notificationId} {
      // Staff-only notifications are only readable by DiCode staff
      // Other notifications are readable by all authenticated users
      allow read: if isAuthenticated() && (
        resource.data.staffOnly != true || isDiCodeStaff()
      );
      // Any authenticated user can create notifications
      allow create: if isAuthenticated();
      // Any authenticated user can update notifications (to mark as read via readBy array)
      allow update: if isAuthenticated();
      // Only DiCode staff can delete notifications
      allow delete: if isAuthenticated() && isDiCodeStaff();
    }

    // Competencies Collection (System Configuration)
    match /competencies/{competencyId} {
      // All authenticated users can read competencies
      allow read: if isAuthenticated();
      // Only DiCode Staff can manage competencies
      allow create, update, delete: if isAuthenticated() && isDiCodeStaff();
    }

    // User Profiles Collection (DiCode Staff Settings)
    match /userProfiles/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);
      // Users can create/update their own profile
      allow create, update: if isOwner(userId);
      // Users can delete their own profile
      allow delete: if isOwner(userId);
    }

    // Support Tickets Collection
    match /supportTickets/{ticketId} {
      // DiCode staff can read all tickets, users can read their own
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        resource.data.userId == request.auth.uid
      );
      // Any authenticated user can create a ticket
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Only DiCode staff can update tickets (assign, resolve, etc.)
      allow update: if isAuthenticated() && isDiCodeStaff();
      // Only DiCode staff can delete tickets
      allow delete: if isAuthenticated() && isDiCodeStaff();
    }

    // Chat Sessions Collection (AI Copilot History)
    match /chatSessions/{sessionId} {
      // Users can read their own chat sessions
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can create their own chat sessions
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can update their own chat sessions
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can delete their own chat sessions
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Assessment Responses Collection (Employee Onboarding)
    match /assessmentResponses/{responseId} {
      // Users can read their own assessment responses, DiCode staff and org admins can read all
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        resource.data.userId == request.auth.uid ||
        isOrgAdmin(getUserOrganization())
      );
      // Users can create their own assessment responses
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can update their own assessment responses
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // DiCode staff can delete assessment responses
      allow delete: if isAuthenticated() && isDiCodeStaff();
    }

    // User Skill Profiles Collection (XP, Levels, Streaks, Skills)
    // Note: profileId is the userId, so we check profileId == request.auth.uid for ownership
    match /userSkillProfiles/{profileId} {
      // Users can read their own skill profile (using doc ID which equals userId)
      // Org admins can read profiles of users in their org (for dashboards)
      // DiCode staff can read all
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        profileId == request.auth.uid ||
        // Check if userSkillProfiles document's organizationId matches requester's organization
        (resource.data != null && resource.data.organizationId != null && resource.data.organizationId == getUserOrganization()) ||
        // Check if the profileId (userId) belongs to a user in the same organization
        // This handles cases where userSkillProfiles document doesn't exist yet or has mismatched organizationId
        (exists(/databases/$(database)/documents/users/$(profileId)) &&
         get(/databases/$(database)/documents/users/$(profileId)).data.organization == getUserOrganization()) ||
        // Allow org admins to read profiles of users in their organization
        (exists(/databases/$(database)/documents/users/$(profileId)) &&
         isOrgAdmin(get(/databases/$(database)/documents/users/$(profileId)).data.organization))
      );
      // Users can create their own skill profile (profileId must match their uid)
      allow create: if isAuthenticated() && profileId == request.auth.uid;
      // Users can update their own skill profile
      allow update: if isAuthenticated() && profileId == request.auth.uid;
      // DiCode staff can delete skill profiles (for account cleanup)
      allow delete: if isAuthenticated() && isDiCodeStaff();
    }

    // User Stats Collection (server-computed streaks & completion rollups)
    match /userStats/{userId} {
      // Users can read their own stats or stats of users in the same organization (for leaderboard)
      // DiCode staff can read all (for support)
      allow read: if isAuthenticated() && (
        userId == request.auth.uid ||
        isDiCodeStaff() ||
        // Check if userStats document's organizationId matches requester's organization
        (resource.data != null && resource.data.organizationId != null && resource.data.organizationId == getUserOrganization()) ||
        // Check if the userId being queried belongs to a user in the same organization
        // This handles cases where userStats document doesn't exist yet or has mismatched organizationId
        (exists(/databases/$(database)/documents/users/$(userId)) &&
         get(/databases/$(database)/documents/users/$(userId)).data.organization == getUserOrganization())
      );
      // Stats are written by Cloud Functions only, EXCEPT lastCelebratedLevel which users can update for themselves
      allow update: if isAuthenticated() && 
        userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastCelebratedLevel']);
      allow create, delete: if false;
    }

    // User Streaks Collection (historical streak records)
    match /userStreaks/{streakId} {
      // Users can read their own streaks; org admins can read streaks of users in their org
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        resource.data.userId == request.auth.uid ||
        (resource.data.organizationId != null && isOrgAdmin(resource.data.organizationId))
      );
      // Streaks are written by Cloud Functions only
      allow create, update, delete: if false;
    }

    // Streak Events Collection (streak activity log)
    match /streakEvents/{eventId} {
      // Users can read their own streak events; org admins can read events of users in their org
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        resource.data.userId == request.auth.uid
      );
      // Events are written by Cloud Functions only
      allow create, update, delete: if false;
    }

    // Skill Assessments Collection (historical skill assessment records)
    match /skillAssessments/{assessmentId} {
      // Users can read their own assessments; org admins can read for analytics
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        resource.data.userId == request.auth.uid ||
        (resource.data.organizationId != null && isOrgAdmin(resource.data.organizationId))
      );
      // Assessments are written by Cloud Functions only
      allow create, update, delete: if false;
    }

    // Organization Notifications Collection (admin notifications for organizations)
    match /organizationNotifications/{notificationId} {
      // Org admins and org members can read notifications for their organization
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        isOrgAdmin(resource.data.organizationId) ||
        resource.data.organizationId == getUserOrganization()
      );
      // Org admins can update notifications (mark as read)
      allow update: if isAuthenticated() && (
        isDiCodeStaff() ||
        isOrgAdmin(resource.data.organizationId) ||
        resource.data.organizationId == getUserOrganization()
      );
      // Created by Cloud Functions only
      allow create: if false;
      // DiCode staff can delete
      allow delete: if isAuthenticated() && isDiCodeStaff();
    }

    // Employee Notifications Collection (in-app notifications for employees)
    match /employeeNotifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can update their own notifications (to mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Notifications are created by Cloud Functions only
      allow create: if false;
      // Users can delete their own notifications, DiCode staff can delete any
      allow delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isDiCodeStaff()
      );
    }


    // Organization Activities Collection
    match /organizationActivities/{activityId} {
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        isOrgAdmin(resource.data.organizationId) ||
        resource.data.organizationId == getUserOrganization()
      );
      allow create: if isAuthenticated() && (
        isDiCodeStaff() ||
        request.resource.data.organizationId == getUserOrganization() ||
        request.resource.data.organizationId == getTokenOrganization()
      );
      allow update, delete: if false;
    }

    // Organization Analytics Collection (aggregated org-level analytics)
    match /organizationAnalytics/{organizationId} {
      // Org admins and members can read their own organization's analytics
      allow read: if isAuthenticated() && (
        isDiCodeStaff() ||
        isOrgAdmin(organizationId) ||
        organizationId == getUserOrganization()
      );
      // Analytics are written by Cloud Functions only
      allow create, update, delete: if false;

      // History subcollection (daily snapshots for trend charts)
      match /history/{dateId} {
        allow read: if isAuthenticated() && (
          isDiCodeStaff() ||
          isOrgAdmin(organizationId) ||
          organizationId == getUserOrganization()
        );
        // Written by Cloud Functions only
        allow create, update, delete: if false;
      }
    }
  }
}
